<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tjekind PHP Cloud: ES Module Lexer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="favicon.ico"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Tjekind PHP Cloud
   &#160;<span id="projectnumber">0.0 Prototype</span>
   </div>
   <div id="projectbrief">Der er brug for at forskellige selvst√¶ndige Tjekind systemer taler til central enhed</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ES Module Lexer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://travis-ci.org/guybedford/es-module-lexer"><object type="image/svg+xml" data="https://travis-ci.org/guybedford/es-module-lexer.svg?branch=master" style="pointer-events: none;">Build Status</object></a></p>
<p>A JS module syntax lexer used in <a href="https://github.com/guybedford/es-module-shims">es-module-shims</a>.</p>
<p>Outputs the list of exports and locations of import specifiers, including dynamic import and import meta handling.</p>
<p>A very small single JS file (4KiB gzipped) that includes inlined Web Assembly for very fast source analysis of ECMAScript module syntax only.</p>
<p>For an example of the performance, Angular 1 (720KiB) is fully parsed in 5ms, in comparison to the fastest JS parser, Acorn which takes over 100ms.</p>
<p><em>Comprehensively handles the JS language grammar while remaining small and fast. - ~10ms per MB of JS cold and ~5ms per MB of JS warm, <a href="#benchmarks">see benchmarks</a> for more info.</em></p>
<h2><a class="anchor" id="autotoc_md8487"></a>
Usage</h2>
<div class="fragment"><div class="line">npm install es-module-lexer</div>
</div><!-- fragment --><p>For use in CommonJS:</p>
<div class="fragment"><div class="line">const { init, parse } = require(&#39;es-module-lexer&#39;);</div>
<div class="line"> </div>
<div class="line">(async () =&gt; {</div>
<div class="line">  // either await init, or call parse asynchronously</div>
<div class="line">  // this is necessary for the Web Assembly boot</div>
<div class="line">  await init;</div>
<div class="line"> </div>
<div class="line">  const [imports, exports] = parse(&#39;export var p = 5&#39;);</div>
<div class="line">  exports[0] === &#39;p&#39;;</div>
<div class="line">})();</div>
</div><!-- fragment --><p>An ES module version is also available:</p>
<p>``&lsquo;js import { init, parse } from 'es-module-lexer&rsquo;;</p>
<p>(async () =&gt; { await init;</p>
<p>const source = &lsquo; import { name } from 'mod&rsquo;; import json from './json.json' assert { type: 'json' } export var p = 5; export function q () {</p>
<p>};</p>
<p>// Comments provided to demonstrate edge cases import /*comment!*/ ('asdf', { assert: { type: 'json' }}); import /*comment!*/.meta.asdf; `;</p>
<p>const [imports, exports] = parse(source, 'optional-sourcename');</p>
<p>// Returns "mod" imports[0].n source.substring(imports[0].s, imports[0].e); // "s" = start // "e" = end</p>
<p>// Returns "import { name } from 'mod'" source.substring(imports[0].ss, imports[0].se); // "ss" = statement start // "se" = statement end</p>
<p>// Returns "{ type: 'json' }" source.substring(imports[1].a, imports[1].se); // "a" = assert</p>
<p>// Returns "p,q" exports.toString();</p>
<p>// Dynamic imports are indicated by imports[2].d &gt; -1 // In this case the "d" index is the start of the dynamic import // Returns true imports[2].d &gt; -1;</p>
<p>// Returns "asdf" imports[2].n // Returns "'asdf'" source.substring(imports[2].s, imports[2].e); // Returns "import /*comment!*&amp;zwj;/ (" source.substring(imports[2].d, imports[2].s); // Returns "import /*comment!*&amp;zwj;/ ('asdf', { assert: { type: 'json' } })" source.substring(imports[2].d, imports[2].se + 1); // Returns "{ assert: { type: 'json' } }" source.substring(imports[2].a, imports[2].e); // ss is the same as d // as, ae not used for dynamic imports</p>
<p>// import.meta is indicated by imports[2].d === -2 // Returns true imports[2].d === -2; // Returns "import /*comment!*&amp;zwj;/.meta" source.substring(imports[2].s, imports[2].e); })(); </p><div class="fragment"><div class="line">### CSP asm.js Build</div>
<div class="line"> </div>
<div class="line">The default version of the library uses Wasm and (safe) eval usage for performance and a minimal footprint.</div>
<div class="line"> </div>
<div class="line">Neither of these represent security escalation possibilities since there are no execution string injection vectors, but that can still violate existing CSP policies for applications.</div>
<div class="line"> </div>
<div class="line">For a version that works with CSP eval disabled, use the `es-module-lexer/js` build:</div>
<div class="line"> </div>
<div class="line">```js</div>
<div class="line">import { parse } from &#39;es-module-lexer/js&#39;;</div>
</div><!-- fragment --><p>Instead of Web Assembly, this uses an asm.js build which is almost as fast as the Wasm version (<a href="#benchmarks">see benchmarks below</a>).</p>
<h2><a class="anchor" id="autotoc_md8488"></a>
Escape Sequences</h2>
<p>To handle escape sequences in specifier strings, the <code>.n</code> field of imported specifiers will be provided where possible.</p>
<p>For dynamic import expressions, this field will be empty if not a valid JS string.</p>
<h2><a class="anchor" id="autotoc_md8489"></a>
Facade Detection</h2>
<p>Facade modules that only use import / export syntax can be detected via the third return value:</p>
<p>``<code>js const [,, facade] = parse(</code> export * from 'external'; import * as ns from 'external2'; export { a as b } from 'external3'; export { ns }; `); facade === true; </p><div class="fragment"><div class="line">### Environment Support</div>
<div class="line"> </div>
<div class="line">Node.js 10+, and [all browsers with Web Assembly support](https://caniuse.com/#feat=wasm).</div>
<div class="line"> </div>
<div class="line">### Grammar Support</div>
<div class="line"> </div>
<div class="line">* Token state parses all line comments, block comments, strings, template strings, blocks, parens and punctuators.</div>
<div class="line">* Division operator / regex token ambiguity is handled via backtracking checks against punctuator prefixes, including closing brace or paren backtracking.</div>
<div class="line">* Always correctly parses valid JS source, but may parse invalid JS source without errors.</div>
<div class="line"> </div>
<div class="line">### Limitations</div>
<div class="line"> </div>
<div class="line">The lexing approach is designed to deal with the full language grammar including RegEx / division operator ambiguity through backtracking and paren / brace tracking.</div>
<div class="line"> </div>
<div class="line">The only limitation to the reduced parser is that the &quot;exports&quot; list may not correctly gather all export identifiers in the following edge cases:</div>
<div class="line"> </div>
<div class="line">```js</div>
<div class="line">// Only &quot;a&quot; is detected as an export, &quot;q&quot; isn&#39;t</div>
<div class="line">export var a = &#39;asdf&#39;, q = z;</div>
<div class="line"> </div>
<div class="line">// &quot;b&quot; is not detected as an export</div>
<div class="line">export var { a: b } = asdf;</div>
</div><!-- fragment --><p>The above cases are handled gracefully in that the lexer will keep going fine, it will just not properly detect the export names above.</p>
<h2><a class="anchor" id="autotoc_md8490"></a>
Benchmarks</h2>
<p>Benchmarks can be run with <code>npm run bench</code>.</p>
<p>Current results for a high spec machine:</p>
<h3><a class="anchor" id="autotoc_md8491"></a>
Wasm Build</h3>
<div class="fragment"><div class="line">Module load time</div>
<div class="line">&gt; 5ms</div>
<div class="line">Cold Run, All Samples</div>
<div class="line">test/samples/*.js (3123 KiB)</div>
<div class="line">&gt; 20ms</div>
<div class="line"> </div>
<div class="line">Warm Runs (average of 25 runs)</div>
<div class="line">test/samples/angular.js (739 KiB)</div>
<div class="line">&gt; 2.12ms</div>
<div class="line">test/samples/angular.min.js (188 KiB)</div>
<div class="line">&gt; 1ms</div>
<div class="line">test/samples/d3.js (508 KiB)</div>
<div class="line">&gt; 3.04ms</div>
<div class="line">test/samples/d3.min.js (274 KiB)</div>
<div class="line">&gt; 2ms</div>
<div class="line">test/samples/magic-string.js (35 KiB)</div>
<div class="line">&gt; 0ms</div>
<div class="line">test/samples/magic-string.min.js (20 KiB)</div>
<div class="line">&gt; 0ms</div>
<div class="line">test/samples/rollup.js (929 KiB)</div>
<div class="line">&gt; 4.04ms</div>
<div class="line">test/samples/rollup.min.js (429 KiB)</div>
<div class="line">&gt; 2.16ms</div>
<div class="line"> </div>
<div class="line">Warm Runs, All Samples (average of 25 runs)</div>
<div class="line">test/samples/*.js (3123 KiB)</div>
<div class="line">&gt; 14.4ms</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md8492"></a>
JS Build (asm.js)</h3>
<div class="fragment"><div class="line">Module load time</div>
<div class="line">&gt; 2ms</div>
<div class="line">Cold Run, All Samples</div>
<div class="line">test/samples/*.js (3123 KiB)</div>
<div class="line">&gt; 35ms</div>
<div class="line"> </div>
<div class="line">Warm Runs (average of 25 runs)</div>
<div class="line">test/samples/angular.js (739 KiB)</div>
<div class="line">&gt; 3ms</div>
<div class="line">test/samples/angular.min.js (188 KiB)</div>
<div class="line">&gt; 1.08ms</div>
<div class="line">test/samples/d3.js (508 KiB)</div>
<div class="line">&gt; 3.04ms</div>
<div class="line">test/samples/d3.min.js (274 KiB)</div>
<div class="line">&gt; 2ms</div>
<div class="line">test/samples/magic-string.js (35 KiB)</div>
<div class="line">&gt; 0ms</div>
<div class="line">test/samples/magic-string.min.js (20 KiB)</div>
<div class="line">&gt; 0ms</div>
<div class="line">test/samples/rollup.js (929 KiB)</div>
<div class="line">&gt; 5.04ms</div>
<div class="line">test/samples/rollup.min.js (429 KiB)</div>
<div class="line">&gt; 3ms</div>
<div class="line"> </div>
<div class="line">Warm Runs, All Samples (average of 25 runs)</div>
<div class="line">test/samples/*.js (3123 KiB)</div>
<div class="line">&gt; 17ms</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8493"></a>
Building</h2>
<p>To build download the WASI SDK from <a href="https://github.com/WebAssembly/wasi-sdk/releases">https://github.com/WebAssembly/wasi-sdk/releases</a>.</p>
<p>The Makefile assumes the existence of "wasi-sdk-11.0" and "wabt" (optional) as sibling folders to this project.</p>
<p>The build through the Makefile is then run via <code>make lib/lexer.wasm</code>, which can also be triggered via <code>npm run build:wasm</code> to create <code>dist/lexer.js</code>.</p>
<p>On Windows it may be preferable to use the Linux subsystem.</p>
<p>After the Web Assembly build, the CJS build can be triggered via <code>npm run build</code>.</p>
<h2><a class="anchor" id="autotoc_md8494"></a>
License</h2>
<p>MIT </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
